name: Build, test and publish image

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Test that the created image is sane
        run: ./gradlew imgTest

      - name: docker login
        env:
          SIMI_DOCKER_USER: ${{ secrets.SIMI_DOCKER_USER }}
          SIMI_DOCKER_PASS: ${{ secrets.SIMI_DOCKER_PASS }}
        run: echo "$SIMI_DOCKER_PASS" | docker login -u "$SIMI_DOCKER_USER" --password-stdin
      - name: Push image with Gradle
        run: ./gradlew pushImg